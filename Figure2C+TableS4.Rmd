---
title: "Figure2C+TableS4"
output: html_document
---

```{r setup, include=FALSE}
# clean enviroment object
rm(list=ls()) 
# load related packages
library("ggplot2") 
library("vegan")
main_theme <- theme(
  panel.background = element_blank(),
  panel.grid = element_blank(),
  axis.line.x = element_line(size = 1, colour = "black"),
  axis.line.y = element_line(size = 1, colour = "black"),
  axis.ticks = element_line(color = "black"),
  axis.text = element_text(color = "black", size = 15, family = "sans"),
  axis.title = element_text(color = "black", size = 15, family = "sans"),
  legend.position = "right",
  legend.background = element_blank(),
  legend.key = element_blank(),
  legend.text = element_text(size = 15, family = "sans"),
  legend.title = element_text(size = 15, family = "sans"),
  text = element_text(family = "sans", size = 15)
)
# Design of experiment
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") #读取实验设计，方便分组
# row.names(bray_curtis)=bray_curtis[,1]
# rownames(bray_curtis)=bray_curtis$bray_curtis
# bray_curtis=bray_curtis[,-1]
bray_curtis = read.table("bray_curtis.txt", sep="\t", header=T, check.names=F)#读取距离矩阵
rownames(bray_curtis)=bray_curtis$bray_curtis
bray_curtis=bray_curtis[,-1]
bray_curtis = bray_curtis[rownames(design), rownames(design)] 

knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
pcoa = cmdscale(bray_curtis, k=4, eig=T) # k is dimension, 3 is recommended; eig is eigenvalues
points = as.data.frame(pcoa$points) # get coordinate string, format to dataframme
colnames(points) = c("x", "y", "z","a") 
eig = pcoa$eig


points = cbind(points, design[match(rownames(points), rownames(design)), ])
#SamplingLocationName+SamplingSeason
points$group <- factor(points$group,levels = c("nonbreeding","breeding"))
points$tissue_explanation <- factor(points$tissue_explanation,levels = c("neck skin","neck feather","skin of preen gland"))
library(ggplot2)


summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
p = ggplot(points, aes(x = x, y = y, color = group, shape = tissue_explanation)) +
  geom_point(size = 3,alpha=0.7) +  # 调整透明度和大小
  labs(
    x = paste("PCoA 1 (", format(100 * eig[1] / sum(eig), digits = 4), "%)", sep = ""),
    y = paste("PCoA 2 (", format(100 * eig[2] / sum(eig), digits = 4), "%)", sep = ""),
    title = "Bray_Curtis PCoA",
    color = "sampling season",  # 设置颜色图例标题
    shape = "body parts"        # 设置形状图例标题
  ) +
  scale_color_manual(values = c("#FFB6C1", "#BDBDBDFF")) +
  main_theme +
  stat_ellipse(aes(group = group, color = group), type = "t", level = 0.95, geom = "path", size = 1.2, alpha = 0.8)  # 添加椭圆轮廓并加深颜色
p

beta_pcoa_phase_bray_curtis1v2 <- p
print(beta_pcoa_phase_bray_curtis1v2)

#统计检验
adonis_result<-adonis2(bray_curtis ~ design$group+design$tissue_explanation+design$sex+design$group*design$tissue_explanation, permutations=9999)
adonis_result

plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
