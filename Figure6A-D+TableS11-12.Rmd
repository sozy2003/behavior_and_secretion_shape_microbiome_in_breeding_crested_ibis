---
title: "Figure6A-D+TableS11-12"
output: html_document
---

```{r setup, include=FALSE}
######6A+B_Fit of the neutral community model during the breeding (A) and non-breeding (B) periods.
# clean enviroment object
rm(list=ls()) 
library(Hmisc)
#install.packages("minpack.lm")
library(minpack.lm) # For non-linear least squares regression
library(stats4)
library(ggplot2)
# Read OTU table with first column as row names
otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")

# spp<-t(otu_table)
# all samples---------
set.seed(0)# Ensure reproducibility of rarefaction
library(vegan)
# Transpose OTU table, rarefy to minimum sample depth, then transpose back
spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))
spp[1:6,1:6]
colSums(spp)
# Transpose again to have samples as rows, ASVs as columns
spp <- t(spp)
spp[1:6,1:6]
# Calculate key ecological metrics
N <- mean(apply(spp, 1, sum))# Average number of reads per sample
p.m <- apply(spp, 2, mean) # Mean read count per ASV across samples
p.m <- p.m[p.m != 0]# Remove ASVs with zero mean abundance
p <- p.m/N     # Convert to relative abundance
spp.bi <- 1*(spp>0) # Binary presence-absence matrix (1=present, 0=absent)
freq <- apply(spp.bi, 2, mean)# Occurrence frequency (fraction of samples where ASV is present)
freq <- freq[freq != 0] # Remove ASVs never observed
# Merge and clean data for modeling
C <- merge(p, freq, by=0) # Merge by ASV identifier (row names)
C <- C[order(C[,2]),]# Sort by relative abundance
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]# Remove rows with zeros
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N# Threshold for presence (1 read in average sample)
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value
m.ci <- confint(m.fit, 'm', level=0.95)
freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value
bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])
# Classify ASVs relative to neutral model predictions
inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '  

#用ggplot作图
main_theme <-  theme(panel.background=element_blank(),
                     panel.grid=element_blank(),
                     axis.line.x=element_line(size=.5, colour="black"),
                     axis.line.y=element_line(size=.5, colour="black"),
                     axis.ticks=element_line(color="black"),
                     axis.text=element_text(color="black", size=15),
                     legend.position="right",
                     legend.background=element_blank(),
                     legend.key=element_blank(),
                     legend.text= element_text(size=15),
                     text=element_text(family="sans", size=15))
# Add model statistics to plot
neutral_model <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+
  main_theme

neutral_model <- neutral_model + annotate("text",x=-4.5,y=0.9, 
                                          label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-4.5,y=0.8, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")

neutral_model <- neutral_model+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model 
neutral_model_allsamples <- neutral_model    
neutral_model_allsamples
# Identify ASV categories based on model
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]
# Calculate total abundance for each category per sample
mat <- otu_table
mat_t <-  t(mat)# Transpose to samples as columns, ASVs as rows
mat_t1 <- as.data.frame(t(mat_t))
# Initialize columns for each category
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)
# Zero out abundances for ASVs not in each category
mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]
# Extract and rename category sums
all_season <- t(mat_t1[,c("above", "below", "middle")])
name <- "all_season"
rownames(all_season) <- paste(name,rownames(all_season), sep=".")
all_season[1:3,1:20]
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
#----------------------breeding————————————————————————————————————
# Public file 1. "design.txt"  Design of experiment
otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 
# Recode 'tissue' variable into more descriptive group names
design$group2 <- design$tissue
design$group2[design$tissue=="I"] <- "skin.of.preen.gland"
design$group2[design$tissue=="f"] <- "neck.feather"
design$group2[design$tissue=="s"] <- "neck.skin"

# Subset metadata to only "breeding" group samples
design_b<-design[design$group=="breeding",]
# Filter OTU table to retain only samples in the breeding group
otu_table <- otu_table[,row.names(design_b)]

# Standardize sequencing depth across samples using rarefaction
set.seed(0)# Ensure reproducibility of random rarefaction
library(vegan)
# Transpose OTU table (samples=rows), rarefy to minimum sample depth, transpose back
spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))
spp[1:6,1:6]
colSums(spp)

spp <- t(spp)
spp[1:6,1:6]

# Calculate key parameters for neutral community model
N <- mean(apply(spp, 1, sum))# Average number of reads per sample
p.m <- apply(spp, 2, mean)# Mean read count per ASV across samples
p.m <- p.m[p.m != 0] # Remove ASVs with zero mean abundance
p <- p.m/N    # Convert to relative abundance
spp.bi <- 1*(spp>0) # Binary matrix (1=present, 0=absent)
freq <- apply(spp.bi, 2, mean)# Occurrence frequency (fraction of samples with ASV)
freq <- freq[freq != 0]# Remove never-observed ASVs
# Merge and clean data for modeling
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value
m.ci <- confint(m.fit, 'm', level=0.95)
# Generate model predictions and confidence intervals
freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
# Wilson score interval for predicted frequencies
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
# Calculate R-squared to assess model fit
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value
# Prepare data for visualization
bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])
# Classify ASVs relative to model predictions
inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '        
# Create neutral model plot using ggplot2
neutral_model_breeding <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme

# Add model statistics (R² and Nm) to plot
neutral_model_breeding <- neutral_model_breeding + annotate("text",x=-5,y=0.85, 
                                                            label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_breeding       


# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]

design.sub <- design[design$group=="breeding",]
#mat <- otu_table[,rownames(design.sub)]
mat <- otu_table
mat_t <-  t(mat)
mat_t1 <- as.data.frame(t(mat_t))
# Initialize columns for each category with total read counts
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)
# Zero out counts for ASVs not in each category
mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0
mat_t1[,c("above", "below", "middle")][1:6,]
# Extract and format category sums
breeding <- t(mat_t1[,c("above", "below", "middle")])
name <- "breeding"
rownames(breeding) <- paste(name,rownames(breeding), sep=".")
breeding[1:3,1:20]# Display subset of results

ggsave(paste("breeding_NCM",".pdf", sep=""), neutral_model_breeding, width =6, height =4 )
# ggsave(neutral_model_spring, file="neutral_model_spring.pdf",width = 6, height = 4)
#nonbreeding#######################################################The following code is similar.

design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 

set.seed(0)
library(vegan)
otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")
design_nb<-design[design$group=="nonbreeding",]
otu_table <- otu_table[,row.names(design_nb)]
spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))
spp[1:6,1:6]
colSums(spp)

spp <- t(spp)
spp[1:6,1:6]


N <- mean(apply(spp, 1, sum))#每一个样本有多少reads
p.m <- apply(spp, 2, mean) #每一个ASV在所有样本平均数目(reads)。
p.m <- p.m[p.m != 0]#选择平均数不为0的ASV
p <- p.m/N    #丰度？
spp.bi <- 1*(spp>0) # ASV数目大于0的赋值为1
freq <- apply(spp.bi, 2, mean)
freq <- freq[freq != 0]
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value
m.ci <- confint(m.fit, 'm', level=0.95)
freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value

bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])
inter.col<-rep('netral model',nrow(bacnlsALL))


inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '        

neutral_model_nonbreeding <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme


neutral_model_autumn <- neutral_model_nonbreeding+ annotate("text",x=-5.5,y=0.85, 
                                                            label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5.5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_autumn         

# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]



design.sub <- design[design$group=="nonbreeding",]
mat <- otu_table[,rownames(design.sub)]
#mat <- otu_table

mat_t <-  t(mat)
mat_t1 <- as.data.frame(t(mat_t))
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)

mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]

nonbreeding <- t(mat_t1[,c("above", "below", "middle")])

name <- "nonbreeding"
rownames(nonbreeding) <- paste(name,rownames(nonbreeding), sep=".")
nonbreeding[1:3,1:20]
#ggsave(paste("nonbreeding_NCM",".pdf", sep=""), neutral_model_autumn, width =6, height =4 )


########################################skin of preen gland breeding

set.seed(0)
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 

otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")


design$group2 <- design$tissue
design$group2[design$tissue=="I"&design$group=="breeding"] <- "skin.of.preen.gland.breeding"
design$group2[design$tissue=="I"&design$group=="nonbreeding"] <- "skin.of.preen.gland.nonbreeding"
design$group2[design$tissue=="D"&design$group=="breeding"] <- "neck.feather.breeding"
design$group2[design$tissue=="D"&design$group=="nonbreeding"] <- "neck.feather.nonbreeding"
design$group2[design$tissue=="F"&design$group=="breeding"] <- "neck.skin.breeding"
design$group2[design$tissue=="F"&design$group=="nonbreeding"] <- "neck.skin.nonbreeding"

#skin.of.preen.gland.nonbreeding
otutab<-otu_table

otu_table <- otutab[,design$group2=="skin.of.preen.gland.breeding"]

spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))

colSums(spp)

spp <- t(spp)

N <- mean(apply(spp, 1, sum))
p.m <- apply(spp, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N    
spp.bi <- 1*(spp>0) 
freq <- apply(spp.bi, 2, mean)
freq <- freq[freq != 0]
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value

m.ci <- confint(m.fit, 'm', level=0.95)

freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value

bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])

inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '  



main_theme <-  theme(panel.background=element_blank(),
                     panel.grid=element_blank(),
                     axis.line.x=element_line(size=.5, colour="black"),
                     axis.line.y=element_line(size=.5, colour="black"),
                     axis.ticks=element_line(color="black"),
                     axis.text=element_text(color="black", size=7),
                     legend.position="right",
                     legend.background=element_blank(),
                     legend.key=element_blank(),
                     legend.text= element_text(size=7),
                     text=element_text(family="sans", size=7))

neutral_model_skin.of.preen.gland <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme


neutral_model_skin.of.preen.gland <- neutral_model_skin.of.preen.gland + annotate("text",x=-5.5,y=0.85, 
                                                                                  label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5.5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_skin.of.preen.gland+annotate("text",x=-5,y=1, 
                                           label= paste("skin.of.preen.gland.breeding"))      


# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]

design.sub <- design[design$group2=="skin.of.preen.gland.breeding",]
mat <- otutab[,rownames(design.sub)]

mat_t <-  t(mat)

mat_t1 <- as.data.frame(t(mat_t))
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)

mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]

skin.of.preen.gland.breeding <- t(mat_t1[,c("above", "below", "middle")])

name <- "skin.of.preen.gland.breeding"
rownames(skin.of.preen.gland.breeding) <- paste(name,rownames(skin.of.preen.gland.breeding), sep=".")
skin.of.preen.gland.breeding[1:3,1:20]

########skin of preen gland nonbreeding

set.seed(0)
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 

otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")


design$group2 <- design$tissue
design$group2[design$tissue=="I"&design$group=="breeding"] <- "skin.of.preen.gland.breeding"
design$group2[design$tissue=="I"&design$group=="nonbreeding"] <- "skin.of.preen.gland.nonbreeding"
design$group2[design$tissue=="D"&design$group=="breeding"] <- "neck.feather.breeding"
design$group2[design$tissue=="D"&design$group=="nonbreeding"] <- "neck.feather.nonbreeding"
design$group2[design$tissue=="F"&design$group=="breeding"] <- "neck.skin.breeding"
design$group2[design$tissue=="F"&design$group=="nonbreeding"] <- "neck.skin.nonbreeding"
otutab<-otu_table

otu_table <- otutab[,design$group2=="skin.of.preen.gland.nonbreeding"]

spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))

colSums(spp)

spp <- t(spp)

N <- mean(apply(spp, 1, sum))
p.m <- apply(spp, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N    
spp.bi <- 1*(spp>0) 
freq <- apply(spp.bi, 2, mean)
freq <- freq[freq != 0]
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value

m.ci <- confint(m.fit, 'm', level=0.95)

freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value

bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])

inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '  



main_theme <-  theme(panel.background=element_blank(),
                     panel.grid=element_blank(),
                     axis.line.x=element_line(size=.5, colour="black"),
                     axis.line.y=element_line(size=.5, colour="black"),
                     axis.ticks=element_line(color="black"),
                     axis.text=element_text(color="black", size=7),
                     legend.position="right",
                     legend.background=element_blank(),
                     legend.key=element_blank(),
                     legend.text= element_text(size=7),
                     text=element_text(family="sans", size=7))

neutral_model_skin.of.preen.gland <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme


neutral_model_skin.of.preen.gland <- neutral_model_skin.of.preen.gland + annotate("text",x=-5.5,y=0.85, 
                                                                                  label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5.5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_skin.of.preen.gland+annotate("text",x=-5.5,y=1, 
                                           label= paste("skin.of.preen.gland.nonbreeding"))      


# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]



design.sub <- design[design$group2=="skin.of.preen.gland.nonbreeding",]
mat <- otutab[,rownames(design.sub)]

mat_t <-  t(mat)

mat_t1 <- as.data.frame(t(mat_t))
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)

mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]

skin.of.preen.gland.nonbreeding <- t(mat_t1[,c("above", "below", "middle")])

name <- "skin.of.preen.gland.nonbreeding"
rownames(skin.of.preen.gland.nonbreeding) <- paste(name,rownames(skin.of.preen.gland.nonbreeding), sep=".")
skin.of.preen.gland.nonbreeding[1:3,1:20]

######################neck skin breeding
set.seed(0)
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 

otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")

design$group2 <- design$tissue
design$group2[design$tissue=="I"&design$group=="breeding"] <- "skin.of.preen.gland.breeding"
design$group2[design$tissue=="I"&design$group=="nonbreeding"] <- "skin.of.preen.gland.nonbreeding"
design$group2[design$tissue=="D"&design$group=="breeding"] <- "neck.feather.breeding"
design$group2[design$tissue=="D"&design$group=="nonbreeding"] <- "neck.feather.nonbreeding"
design$group2[design$tissue=="F"&design$group=="breeding"] <- "neck.skin.breeding"
design$group2[design$tissue=="F"&design$group=="nonbreeding"] <- "neck.skin.nonbreeding"

#skin.of.preen.gland.nonbreeding
otutab<-otu_table

otu_table <- otutab[,design$group2=="neck.skin.breeding"]
spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))

colSums(spp)

spp <- t(spp)

N <- mean(apply(spp, 1, sum))
p.m <- apply(spp, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N    
spp.bi <- 1*(spp>0) 
freq <- apply(spp.bi, 2, mean)
freq <- freq[freq != 0]
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value

m.ci <- confint(m.fit, 'm', level=0.95)

freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value


bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])

inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '  



main_theme <-  theme(panel.background=element_blank(),
                     panel.grid=element_blank(),
                     axis.line.x=element_line(size=.5, colour="black"),
                     axis.line.y=element_line(size=.5, colour="black"),
                     axis.ticks=element_line(color="black"),
                     axis.text=element_text(color="black", size=7),
                     legend.position="right",
                     legend.background=element_blank(),
                     legend.key=element_blank(),
                     legend.text= element_text(size=7),
                     text=element_text(family="sans", size=7))

neutral_model_neck.skin <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme


neutral_model_neck.skin <- neutral_model_neck.skin + annotate("text",x=-5.5,y=0.85, 
                                                              label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5.5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_neck.skin+annotate("text",x=-5,y=1, 
                                 label= paste("neck.skin.breeding"))      


# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]

design.sub <- design[design$group2=="neck.skin.breeding",]
mat <- otutab[,rownames(design.sub)]

mat_t <-  t(mat)

mat_t1 <- as.data.frame(t(mat_t))
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)

mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]


neck.skin.breeding <- t(mat_t1[,c("above", "below", "middle")])

name <- "neck.skin.breeding"
rownames(neck.skin.breeding) <- paste(name,rownames(neck.skin.breeding), sep=".")
neck.skin.breeding[1:3,1:20]

##############neck skin nonbreeding
set.seed(0)
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 

otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")

design$group2 <- design$tissue
design$group2[design$tissue=="I"&design$group=="breeding"] <- "skin.of.preen.gland.breeding"
design$group2[design$tissue=="I"&design$group=="nonbreeding"] <- "skin.of.preen.gland.nonbreeding"
design$group2[design$tissue=="D"&design$group=="breeding"] <- "neck.feather.breeding"
design$group2[design$tissue=="D"&design$group=="nonbreeding"] <- "neck.feather.nonbreeding"
design$group2[design$tissue=="F"&design$group=="breeding"] <- "neck.skin.breeding"
design$group2[design$tissue=="F"&design$group=="nonbreeding"] <- "neck.skin.nonbreeding"

#skin.of.preen.gland.nonbreeding
otutab<-otu_table

otu_table <- otutab[,design$group2=="neck.skin.nonbreeding"]

spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))

colSums(spp)

spp <- t(spp)

N <- mean(apply(spp, 1, sum))
p.m <- apply(spp, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N    
spp.bi <- 1*(spp>0) 
freq <- apply(spp.bi, 2, mean)
freq <- freq[freq != 0]
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value

m.ci <- confint(m.fit, 'm', level=0.95)

freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value


bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])

inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '  



main_theme <-  theme(panel.background=element_blank(),
                     panel.grid=element_blank(),
                     axis.line.x=element_line(size=.5, colour="black"),
                     axis.line.y=element_line(size=.5, colour="black"),
                     axis.ticks=element_line(color="black"),
                     axis.text=element_text(color="black", size=7),
                     legend.position="right",
                     legend.background=element_blank(),
                     legend.key=element_blank(),
                     legend.text= element_text(size=7),
                     text=element_text(family="sans", size=7))

neutral_model_neck.skin <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme


neutral_model_neck.skin <- neutral_model_neck.skin + annotate("text",x=-5,y=0.85, 
                                                              label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_neck.skin+annotate("text",x=-5,y=1, 
                                 label= paste("neck.skin.nonbreeding"))      


# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]



design.sub <- design[design$group2=="neck.skin.nonbreeding",]
mat <- otutab[,rownames(design.sub)]

mat_t <-  t(mat)

mat_t1 <- as.data.frame(t(mat_t))
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)

mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]

neck.skin.nonbreeding <- t(mat_t1[,c("above", "below", "middle")])

name <- "neck.skin.nonbreeding"
rownames(neck.skin.nonbreeding) <- paste(name,rownames(neck.skin.nonbreeding), sep=".")
neck.skin.nonbreeding[1:3,1:20]


#########################neck feather breeding
set.seed(0)
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 

otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")

design$group2 <- design$tissue
design$group2[design$tissue=="I"&design$group=="breeding"] <- "skin.of.preen.gland.breeding"
design$group2[design$tissue=="I"&design$group=="nonbreeding"] <- "skin.of.preen.gland.nonbreeding"
design$group2[design$tissue=="D"&design$group=="breeding"] <- "neck.feather.breeding"
design$group2[design$tissue=="D"&design$group=="nonbreeding"] <- "neck.feather.nonbreeding"
design$group2[design$tissue=="F"&design$group=="breeding"] <- "neck.skin.breeding"
design$group2[design$tissue=="F"&design$group=="nonbreeding"] <- "neck.skin.nonbreeding"

#skin.of.preen.gland.nonbreeding
otutab<-otu_table

#otu_table <- otutab[,design$group2=="neck.feather.nonbreeding"]
otu_table <- otutab[,design$group2=="neck.feather.breeding"]


spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))

colSums(spp)

spp <- t(spp)

N <- mean(apply(spp, 1, sum))
p.m <- apply(spp, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N    
spp.bi <- 1*(spp>0) 
freq <- apply(spp.bi, 2, mean)
freq <- freq[freq != 0]
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value

m.ci <- confint(m.fit, 'm', level=0.95)

freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value

bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])

inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '  



main_theme <-  theme(panel.background=element_blank(),
                     panel.grid=element_blank(),
                     axis.line.x=element_line(size=.5, colour="black"),
                     axis.line.y=element_line(size=.5, colour="black"),
                     axis.ticks=element_line(color="black"),
                     axis.text=element_text(color="black", size=7),
                     legend.position="right",
                     legend.background=element_blank(),
                     legend.key=element_blank(),
                     legend.text= element_text(size=7),
                     text=element_text(family="sans", size=7))

neutral_model_neck.feather <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme


neutral_model_neck.feather <- neutral_model_neck.feather + annotate("text",x=-5.5,y=0.85, 
                                                                    label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5.5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_neck.feather+annotate("text",x=-5,y=1, 
                                    label= paste("neck.feather.breeding"))      


# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]



design.sub <- design[design$group2=="neck.feather.nonbreeding",]
mat <- otutab[,rownames(design.sub)]

design.sub <- design[design$group2=="neck.feather.breeding",]
mat <- otutab[,rownames(design.sub)]

mat_t <-  t(mat)

mat_t1 <- as.data.frame(t(mat_t))
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)

mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]

neck.feather.nonbreeding <- t(mat_t1[,c("above", "below", "middle")])
neck.feather.breeding <- t(mat_t1[,c("above", "below", "middle")])

name <- "neck.feather.nonbreeding"
rownames(neck.feather.nonbreeding) <- paste(name,rownames(neck.feather.nonbreeding), sep=".")
neck.feather.nonbreeding[1:3,1:20]

name <- "neck.feather.breeding"
rownames(neck.feather.breeding) <- paste(name,rownames(neck.feather.breeding), sep=".")
neck.feather.breeding[1:3,1:20]

####################neck feather nonbreeding
set.seed(0)
design = read.table("metadata.txt", header=T, row.names= 1, sep="\t") 

otu_table <-  read.delim("otutab.txt", row.names= 1,  header=T, sep="\t")

design$group2 <- design$tissue
design$group2[design$tissue=="I"&design$group=="breeding"] <- "skin.of.preen.gland.breeding"
design$group2[design$tissue=="I"&design$group=="nonbreeding"] <- "skin.of.preen.gland.nonbreeding"
design$group2[design$tissue=="D"&design$group=="breeding"] <- "neck.feather.breeding"
design$group2[design$tissue=="D"&design$group=="nonbreeding"] <- "neck.feather.nonbreeding"
design$group2[design$tissue=="F"&design$group=="breeding"] <- "neck.skin.breeding"
design$group2[design$tissue=="F"&design$group=="nonbreeding"] <- "neck.skin.nonbreeding"

#skin.of.preen.gland.nonbreeding
otutab<-otu_table

otu_table <- otutab[,design$group2=="neck.feather.nonbreeding"]

spp= as.data.frame(t(rrarefy(t(otu_table), min(colSums(otu_table)))))

colSums(spp)

spp <- t(spp)

N <- mean(apply(spp, 1, sum))
p.m <- apply(spp, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N    
spp.bi <- 1*(spp>0) 
freq <- apply(spp.bi, 2, mean)
freq <- freq[freq != 0]
C <- merge(p, freq, by=0)
C <- C[order(C[,2]),]
C <- as.data.frame(C)
C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),]
p <- C.0[,2]
freq <- C.0[,3]
names(p) <- C.0[,1]
names(freq) <- C.0[,1]
d = 1/N
##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1 -p), lower.tail=FALSE),start=list(m=0.1))
m.fit #get the m value

m.ci <- confint(m.fit, 'm', level=0.95)

freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1 -p), lower.tail=FALSE)
pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
Rsqr# get the R2 value

bacnlsALL <-data.frame(p,freq,freq.pred,pred.ci[,2:3])

inter.col<-rep('netral model',nrow(bacnlsALL))
inter.col[bacnlsALL$freq <= bacnlsALL$Lower]<-'Underrepresented ASVs'   
inter.col[bacnlsALL$freq >= bacnlsALL$Upper]<-'Overrepresented ASVs '  



main_theme <-  theme(panel.background=element_blank(),
                     panel.grid=element_blank(),
                     axis.line.x=element_line(size=.5, colour="black"),
                     axis.line.y=element_line(size=.5, colour="black"),
                     axis.ticks=element_line(color="black"),
                     axis.text=element_text(color="black", size=7),
                     legend.position="right",
                     legend.background=element_blank(),
                     legend.key=element_blank(),
                     legend.text= element_text(size=7),
                     text=element_text(family="sans", size=7))

neutral_model_neck.feather <- ggplot(bacnlsALL,aes(x=log10(p), y=freq))+
  geom_point(aes(color=inter.col),alpha=0.5)+
  geom_line(aes(x=log10(p), y=freq.pred), lwd=0.8)+
  geom_line(aes(x=log10(p), y=Lower), lwd=0.8,lty=2, color="blue")+
  geom_line(aes(x=log10(p), y=Upper), lwd=0.8,lty=2, color="blue")+
  scale_color_manual(values = c("red","blue", "black"))+main_theme


neutral_model_neck.feather <- neutral_model_neck.feather + annotate("text",x=-5.5,y=0.85, 
                                                                    label= paste("R^2=",round(Rsqr,3)))+
  annotate("text",x=-5.5,y=0.80, 
           label= paste("Nm=",round(coef(m.fit)*N)))+
  xlab("log (Mean relative abundance)")+
  ylab("Occurrence frequency")+
  scale_color_manual(values=c("#E64B357F","#3C54887F","#91D1C27F" ))

neutral_model_neck.feather+annotate("text",x=-5,y=1, 
                                    label= paste("neck.feather.nonbreeding"))      


# partion by above, below and middle 
above.list <- rownames(bacnlsALL)[bacnlsALL$freq >= bacnlsALL$Upper]
below.list <- rownames(bacnlsALL)[bacnlsALL$freq <= bacnlsALL$Lower]
middle.list <- rownames(bacnlsALL)[bacnlsALL$freq < bacnlsALL$Upper&bacnlsALL$freq > bacnlsALL$Lower]



design.sub <- design[design$group2=="neck.feather.nonbreeding",]
mat <- otutab[,rownames(design.sub)]

mat_t <-  t(mat)

mat_t1 <- as.data.frame(t(mat_t))
mat_t1$above <- rowSums(mat_t1)
mat_t1$below <- rowSums(mat_t1)
mat_t1$middle <- rowSums(mat_t1)

mat_t1$above[!rownames(mat_t1)%in%above.list] <- 0
mat_t1$below [!rownames(mat_t1)%in%below.list]<- 0
mat_t1$middle[!rownames(mat_t1)%in%middle.list] <- 0

mat_t1[,c("above", "below", "middle")][1:6,]

neck.feather.nonbreeding <- t(mat_t1[,c("above", "below", "middle")])

name <- "neck.feather.nonbreeding"
rownames(neck.feather.nonbreeding) <- paste(name,rownames(neck.feather.nonbreeding), sep=".")
neck.feather.nonbreeding[1:3,1:20]

plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
########6C_PCoA visualization based on the Bray–Curtis distance for neutral and non-neutral partitions.
otu.t <- rbind(neck.skin.breeding,
               neck.skin.nonbreeding,
               neck.feather.breeding,neck.feather.nonbreeding,
               skin.of.preen.gland.breeding,
               skin.of.preen.gland.nonbreeding)

otu <- t(otu.t)
str(otu)
set.seed(0)
otu_Flattening = as.data.frame(t(rrarefy(t(otu), min(colSums(otu)))))####抽平

bray_curtis<- vegdist(t(otu_Flattening),method="bray")

bray_curtis <- as.matrix(bray_curtis)

set.seed(000)
pcoa = cmdscale(bray_curtis, k=4, eig=T) 
points = as.data.frame(pcoa$points) # get coordinate string, format to dataframme
colnames(points) = c("x", "y", "z","a") 
eig = pcoa$eig

design.partion <- data.frame(names=rownames(bray_curtis), 
                             tissue=rep(c("neck.skin.breeding","neck.skin.nonbreeding","neck.feather.breeding","neck.feather.nonbreeding","skin.of.preen.gland.breeding","skin.of.preen.gland.nonbreeding" ),rep(3,6)),
                             partion=rep(c("above", "below", "middle"),6)
)

rownames(design.partion) <- design.partion$names
design.partion <- design.partion[,-1]
design.partion$habitat <- design.partion$tissue

design.partion$habitat[design.partion$habitat%in%c("neck.skin.breeding","neck.skin.nonbreeding","neck.feather.breeding","neck.feather.nonbreeding","skin.of.preen.gland.breeding","skin.of.preen.gland.nonbreeding" )] <- "tissue"

points = cbind(points, design.partion[match(rownames(points), rownames(design.partion)), ])


tissue_level <- c("neck.skin.breeding","neck.skin.nonbreeding","neck.feather.breeding","neck.feather.nonbreeding","skin.of.preen.gland.breeding","skin.of.preen.gland.nonbreeding" )
points$tissue <- factor(points$tissue, level=tissue_level)


cl=c("#E64B357F", "#3C54887F","#91D1C27F")
# 定义 shape 映射
shape_mapping <- c(
  "neck.skin.breeding" = 16,               # 实心圆
  "neck.feather.breeding" = 17,            # 实心三角
  "skin.of.preen.gland.breeding" = 15,     # 实心正方
  "neck.skin.nonbreeding" = 1,             # 空心圆
  "neck.feather.nonbreeding" = 2,          # 空心三角
  "skin.of.preen.gland.nonbreeding" = 0    # 空心正方
)

#  ggplot 
p <- ggplot(points, aes(x = x, y = y, color = partion, shape = tissue)) +
  geom_point(alpha = 1, size = 3.5) +
  labs(
    x = paste("PCoA 1 (", format(100 * eig[1] / sum(eig), digits = 4), "%)", sep = ""),
    y = paste("PCoA 2 (", format(100 * eig[2] / sum(eig), digits = 4), "%)", sep = ""),
    title = "Bray_Curtis PCoA"
  ) +
  main_theme +
  scale_color_manual(values = cl) +
  scale_shape_manual(values = shape_mapping) +
  theme(legend.position = "right")

pcoa_neutral_partion <- p
p

plot(pressure)
```

```{r pressure, echo=FALSE}
######6D_Proportion of ASVs in above, below, and neutral partitions.
bar <- data.frame(neck.skin.breeding=c(table(t(neck.skin.breeding) [,1]>0)[2],
                                       table(t(neck.skin.breeding) [,2]>0)[2],
                                       table(t(neck.skin.breeding) [,3]>0)[2]),
                  neck.skin.nonbreeding=c(table(t(neck.skin.nonbreeding) [,1]>0)[2],
                                          table(t(neck.skin.nonbreeding) [,2]>0)[2],
                                          table(t(neck.skin.nonbreeding) [,3]>0)[2]),
                  neck.feather.breeding=c(table(t(neck.feather.breeding) [,1]>0)[2],
                                          table(t(neck.feather.breeding) [,2]>0)[2],
                                          table(t(neck.feather.breeding) [,3]>0)[2]),
                  neck.feather.nonbreeding=c(table(t(neck.feather.nonbreeding) [,1]>0)[2],
                                             table(t(neck.feather.nonbreeding) [,2]>0)[2],
                                             table(t(neck.feather.nonbreeding) [,3]>0)[2]),
                  skin.of.preen.gland.breeding=c(table(t(skin.of.preen.gland.breeding) [,1]>0)[2],
                                                 table(t(skin.of.preen.gland.breeding) [,2]>0)[2],
                                                 table(t(skin.of.preen.gland.breeding) [,3]>0)[2]),
                  skin.of.preen.gland.nonbreeding=c(table(t(skin.of.preen.gland.nonbreeding) [,1]>0)[2],
                                                    table(t(skin.of.preen.gland.nonbreeding) [,2]>0)[2],
                                                    table(t(skin.of.preen.gland.nonbreeding) [,3]>0)[2]))


rownames(bar) <- c("Above", "Below", "Neutral")

per <-  t(t(bar)/colSums(bar,na=T)) * 100 

#install.packages("reshape2")  
library(reshape2)
bar.long <- as.data.frame(melt(per, value.name = "value"))
colnames(bar.long)[1:2] <- c("partion", "habitat")

cl=c("#E64B357F", "#3C54887F","#91D1C27F")

p <- ggplot(bar.long,aes(x=habitat,y=value, fill=partion))+
  geom_bar(stat = "identity", position = "dodge", alpha=1)+
  scale_fill_manual(values=cl)+main_theme+
  labs(x="", y="proportion of OTUs")+
  theme(axis.text.x = element_text(angle = 30,vjust = 0.85,hjust = 0.75))
otu.per.4habitats <- p
otu.per.4habitats #Figure 5f
#ggsave(paste("ASV",".pdf", sep=""), p, width =5, height =4 )
```
